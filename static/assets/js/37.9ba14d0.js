(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{"4kjr":function(t,e,i){"use strict";i.r(e);var a=i("y+Qj"),n=i("M4tW");for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s);i("S4HZ");var o=i("KHd+"),c=Object(o.a)(n.default,a.a,a.b,!1,null,"2cfb4a4a",null);e.default=c.exports},BVo6:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"CreateTickerSuccer",props:{routerInfo:Object},data:function(){return{time:10,timer:"",isStart:!0}},mounted:function(){this.countDown()},beforeDestroy:function(){clearInterval(this.timer)},methods:{countDown:function(){var t=this;this.isStart&&(this.timer=setInterval((function(){t.time-=1,0===t.time&&(clearInterval(t.timer),t.jumpPage())}),1e3))},jumpPage:function(){clearInterval(this.timer),this.isStart=!1,this.$router.push(this.routerInfo)},onBackClick:function(){clearInterval(this.timer),this.isStart=!1,this.$emit("onBackIconClick")}}}},CXTO:function(t,e,i){"use strict";i.r(e);var a=i("STRs"),n=i("hrEm");for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s);i("sj1o");var o=i("KHd+"),c=Object(o.a)(n.default,a.a,a.b,!1,null,"2a4cb86c",null);e.default=c.exports},ISVW:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=v(i("14Xm")),n=v(i("D3Ub")),s=v(i("+qVm")),o=v(i("BWJp")),c=v(i("tQ05")),r=v(i("1xNg")),l=v(i("PaSM")),m=i("CeR/"),u=i("ygAv"),d=v(i("u8Ap")),f=v(i("4kjr"));function v(t){return t&&t.__esModule?t:{default:t}}e.default={name:"CreateTicket",components:{NavTitle:s.default,FieldInfo:c.default,memberSelect:d.default,CreateTicketDialog:r.default,CreateTicketSuccess:f.default},mixins:[o.default,l.default],inject:["reload"],data:function(){return{submitting:!1,serviceLoading:!1,templateListLoading:!1,fieldListLoading:!1,serviceId:"",creator:[],favorite:!1,service:{},tempalteId:"",templateInfo:{},templateList:[],templateFormData:{name:""},rules:{},fieldList:[],reCreateFieldList:[],remindCheck:!1,isCreateTicketDialogShow:!1,isRemindPageShow:!1,routerInfo:{},isShowTemplateList:!1}},watch:{$route:function(){this.reload()}},created:function(){this.initData()},methods:{initData:function(){var t=this;return(0,n.default)(a.default.mark((function e(){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.rules.name=t.checkCommonRules("name").name,t.serviceId=t.$route.query.service_id,t.getTemplateList(),e.next=5,t.getServiceDetail();case 5:return e.next=7,t.getFieldList();case 7:t.$route.query.rc_ticket_id&&t.getReCreateTicketInfo();case 8:case"end":return e.stop()}}),e,t)})))()},handleTemplateSelect:function(){0!==this.templateList.length?this.isShowTemplateList=!this.isShowTemplateList:this.$bkMessage({message:this.$t("m['暂无模板']"),offsetY:80})},getServiceDetail:function(){var t=this;return this.serviceLoading=!0,this.$store.dispatch("service/getServiceDetail",this.serviceId).then((function(e){t.service=e.data,t.favorite=e.data.favorite})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.serviceLoading=!1}))},getTemplateList:function(){var t=this;this.templateListLoading=!0;var e={service:this.serviceId};return this.$store.dispatch("change/getTemplateList",e).then((function(e){t.templateList=e.data})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.templateListLoading=!1}))},getFieldList:function(){var t=this;this.fieldListLoading=!0;var e,i={service_id:this.serviceId};return this.$store.dispatch("change/getSubmitFields",i).then((e=(0,n.default)(a.default.mark((function e(i){var n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.fieldList=i.data,n=t.fieldList.some((function(t){return"impact"===t.key||"urgency"===t.key})),t.fieldList.forEach((function(e){"CASCADE"===e.type&&(e.type="SELECT"),"priority"!==e.key||n||t.$set(e,"is_readonly",!1),t.$set(e,"showFeild",!0),t.$set(e,"val",e.value),t.$set(e,"service",t.service.key)})),t.isNecessaryToWatch({fields:t.fieldList},"submit",(function(){t.fieldList.forEach((function(e){t.reCreateFieldList.forEach((function(t){e.key===t.key&&(e.val=t.value)}))}))}));case 4:case"end":return e.stop()}}),e,t)}))),function(t){return e.apply(this,arguments)})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.fieldListLoading=!1}))},getReCreateTicketInfo:function(){var t=this,e=this.$route.query.rc_ticket_id;return this.fieldListLoading=!0,this.$store.dispatch("change/getCreateTicektParams",{id:e}).then((function(e){e.result&&e.data.fields&&e.data.fields.length&&(t.reCreateFieldList=e.data.fields,t.fieldList.forEach((function(t){e.data.fields.forEach((function(e){t.key===e.key&&(t.val=e.value)}))})))})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.fieldListLoading=!1}))},onCreateTicket:function(){var t=this;if(!this.submitting){if(this.$refs.fieldInfo.fieldChange(),!this.$refs.fieldInfo.checkValue())return this.$nextTick((function(){var t=document.querySelector(".bk-task-error");document.querySelector(".create-ticket-body").scrollTop=t?t.getBoundingClientRect().y+200:0})),!1;this.submitting=!0;var e={catalog_id:this.service.catalog_id,service_id:this.service.id,service_type:this.service.bounded_catalogs[0],fields:[],creator:this.creator[0]||window.username,attention:this.remindCheck};this.fieldList.forEach((function(t){e.fields.push({type:t.type,id:t.id,key:t.key,value:t.showFeild?t.value:"",choice:t.choice})})),this.$store.dispatch("change/submit",e).then((function(e){t.$bkMessage({message:t.$t('m.common["提交成功！"]'),theme:"success"}),t.isRemindPageShow=!0,t.routerInfo={name:"TicketDetail",params:{type:"readOnly"},query:{id:e.data.id,from:"created",project_id:t.$route.query.project_id||void 0}}})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.submitting=!1}))}},onChangeService:function(){this.isCreateTicketDialogShow=!0},getSaveTemplateParams:function(){var t=this,e={name:this.templateFormData.name,service:this.serviceId,template:[]},i=["FILE","TABLE","CUSTOMTABLE"];return this.fieldList.forEach((function(a){if(""!==a.val&&!i.includes(a.type)){var n={id:a.id,key:a.key,type:a.type,value:a.val};"DATE"===n.type&&(n.value=t.standardDayTime(n.value)),"DATETIME"===n.type&&(n.value=t.standardTime(n.value)),e.template.push(n)}})),e},onOpenUpdateTemplate:function(){var t=this,e=(0,u.deepClone)(this.getSaveTemplateParams());return e.template.length?!this.submitting&&void this.$bkInfo({type:"warning",title:this.$t('m.common["确认更新模板？"]'),subTitle:this.$t('m.common["更新模板操作将会覆盖原先模板的信息"]'),confirmFn:function(){t.submitting=!0;var i=t.tempalteId,a=t.templateList.find((function(e){return e.id===t.tempalteId})).name;e.name=a,t.$store.dispatch("change/updateTemplate",{params:e,id:i}).then((function(){t.$bkMessage({message:t.$t('m.common["模板更新成功"]'),theme:"success",ellipsisLine:0})})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.getTemplateList(),t.submitting=!1}))}}):(this.$bkMessage({message:this.$t('m.common["无字段可以保存"]'),theme:"warning"}),this.cancelTemplate(),!1)},onSaveTemplate:function(){var t=this,e=this.getSaveTemplateParams();return e.template.length?!this.submitting&&void this.$refs.templateForm.validate().then((function(){t.submitting=!0,t.$store.dispatch("change/submitTemplate",e).then((function(){t.getTemplateList(),t.$bkMessage({message:t.$t('m.common["保存成功"]'),theme:"success"})})).catch((function(e){(0,m.errorHandler)(e,t)})).finally((function(){t.submitting=!1,t.cancelTemplate()}))})):(this.$bkMessage({message:this.$t('m.common["无字段可以保存"]'),theme:"warning"}),this.cancelTemplate(),!1)},cancelTemplate:function(){this.templateFormData.name="",this.$refs.templatePopover.hideHandler()},handleTemplateChange:function(t){this.tempalteId=t;var e=this.templateList.find((function(e){return e.id===t})).template||[];this.fieldList.forEach((function(t){e.forEach((function(e){t.key===e.key&&(t.val=e.value)}))}))},onBackIconClick:function(){var t=void 0;t=this.$route.query.from?{name:this.$route.query.from}:{name:"projectTicket",query:{project_id:this.$store.state.project.id}},this.$router.push(t)},onCollectClick:function(){var t=this;this.$store.dispatch("service/toggleServiceFavorite",{id:this.serviceId,favorite:!this.favorite}).then((function(e){e.result&&(t.favorite=!t.favorite),t.$bkMessage({message:t.favorite?t.$t("m.manageCommon['收藏成功']"):t.$t("m.manageCommon['取消成功']"),theme:"success",ellipsisLine:0})})).catch((function(e){(0,m.errorHandler)(e,t)}))}}}},JDVe:function(t,e,i){},M4tW:function(t,e,i){"use strict";i.r(e);var a=i("BVo6"),n=i.n(a);for(var s in a)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(s);e.default=n.a},Nxk6:function(t,e,i){i("dbV7"),t.exports=9007199254740991},S4HZ:function(t,e,i){"use strict";i("JDVe")},STRs:function(t,e,i){"use strict";i.d(e,"a",(function(){return a})),i.d(e,"b",(function(){return n}));var a=function(){var t=this,e=t._self._c;return e("div",{staticClass:"create-ticket-page"},[e("nav-title",{attrs:{"show-icon":!0,"title-name":t.$t("m.navigation['提单']")},on:{goBack:t.onBackIconClick}}),t._v(" "),t.isRemindPageShow?t._e():e("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.serviceLoading},expression:"{ isLoading: serviceLoading }"}],staticClass:"create-ticket-body"},[e("section",{staticClass:"service-info"},[t._m(0),t._v(" "),e("div",{staticClass:"service-description"},[e("h3",{staticClass:"service-title"},[e("span",{staticClass:"service-name"},[t._v(t._s(t.service.name))]),t._v(" "),e("i",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips",value:{content:t.favorite?t.$t("m.common['取消收藏']"):t.$t("m.common['添加收藏']"),placement:"top",delay:[300,0]},expression:"{\n              content: favorite ? $t(`m.common['取消收藏']`) : $t(`m.common['添加收藏']`),\n              placement: 'top',\n              delay: [300, 0]\n            }"}],class:["bk-itsm-icon favorite",t.favorite?"icon-favorite":"icon-rate"],on:{click:function(e){return e.stopPropagation(),t.onCollectClick.apply(null,arguments)}}}),t._v(" "),e("span",{staticClass:"change-service",on:{click:t.onChangeService}},[t._v(t._s(t.$t("m.common['切换服务']")))])]),t._v(" "),e("pre",{staticClass:"service-content"},[t._v(t._s(t.service.desc||t.$t("m.common['暂无描述']")))])])]),t._v(" "),e("section",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.fieldListLoading},expression:"{ isLoading: fieldListLoading }"}],staticClass:"form-panel creaet-fields"},[e("div",{staticClass:"panel-label"},[e("h3",{staticClass:"panel-label-name"},[t._v(t._s(t.$t("m.tickets['提单信息']")))]),t._v(" "),e("div",{staticClass:"select-template",on:{click:t.handleTemplateSelect}},[e("span",[t._v(t._s(t.$t("m['模板选择']")))]),t._v(" "),e("i",{class:["bk-itsm-icon",t.isShowTemplateList?"icon-arrow-bottom":"icon-arrow-right"]}),t._v(" "),e("ul",{directives:[{name:"show",rawName:"v-show",value:t.isShowTemplateList&&0!==t.templateList.length,expression:"isShowTemplateList && templateList.length !== 0"}],staticClass:"template-list"},t._l(t.templateList,(function(i){return e("li",{key:i.id,on:{click:function(e){return t.handleTemplateChange(i.id)}}},[t._v("\n              "+t._s(i.name)+"\n            ")])})),0)])]),t._v(" "),t.serviceLoading||t.fieldListLoading?t._e():e("div",{staticClass:"panel-content"},[t.service.can_ticket_agency?e("div",{staticClass:"bk-member-form"},[e("p",{staticClass:"bk-member-label"},[t._v(t._s(t.$t("m.common['提单人']")))]),t._v(" "),e("member-select",{staticStyle:{height:"32px"},attrs:{multiple:!1},model:{value:t.creator,callback:function(e){t.creator=e},expression:"creator"}})],1):t._e(),t._v(" "),e("field-info",{ref:"fieldInfo",attrs:{fields:t.fieldList}}),t._v(" "),e("div",{staticClass:"ticket-remind"},[e("bk-checkbox",{model:{value:t.remindCheck,callback:function(e){t.remindCheck=e},expression:"remindCheck"}},[t._v("\n            "+t._s(t.$t('m.common["关注单据，单据进度更新时通知我"]'))+"\n          ")])],1)],1)]),t._v(" "),e("div",{staticClass:"bottom-group mt20"},[e("bk-button",{staticClass:"mr10",attrs:{theme:"primary","data-test-id":"createTicket-button-submit",title:t.$t("m.common['提交']"),loading:t.submitting},on:{click:t.onCreateTicket}},[t._v("\n        "+t._s(t.$t("m.common['提交']"))+"\n      ")]),t._v(" "),e("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:t.$t("m['取消']"),disabled:t.submitting},on:{click:t.onBackIconClick}},[t._v("\n        "+t._s(t.$t("m['取消']"))+"\n      ")]),t._v(" "),e("bk-popover",{ref:"templatePopover",attrs:{placement:"bottom-start",trigger:"click","ext-cls":"save-template-pop",theme:"light"}},[t.tempalteId?e("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:t.$t("m.common['更新模板']"),disabled:t.submitting},on:{click:function(e){return e.stopPropagation(),t.onOpenUpdateTemplate.apply(null,arguments)}}},[t._v("\n          "+t._s(t.$t("m.common['更新模板']"))+"\n        ")]):t._e(),t._v(" "),t.tempalteId?e("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:t.$t("m.common['另存为模板']"),disabled:t.submitting}},[t._v("\n          "+t._s(t.$t("m.common['另存为模板']"))+"\n        ")]):e("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:t.$t("m.common['存为模板']"),disabled:t.submitting}},[t._v("\n          "+t._s(t.$t("m.common['存为模板']"))+"\n        ")]),t._v(" "),e("div",{staticStyle:{width:"320px"},attrs:{slot:"content"},slot:"content"},[e("h3",{staticClass:"save-title"},[t._v(t._s(t.$t("m.common['存为模板']")))]),t._v(" "),e("bk-form",{ref:"templateForm",attrs:{width:"320","form-type":"vertical",model:t.templateFormData,rules:t.rules}},[e("bk-form-item",{attrs:{label:"",required:!0,property:"name"}},[e("bk-input",{attrs:{maxlength:"120",placeholder:t.$t("m.common['请输入模板名称']")},model:{value:t.templateFormData.name,callback:function(e){t.$set(t.templateFormData,"name",e)},expression:"templateFormData.name"}})],1)],1),t._v(" "),e("div",{staticClass:"btn-group"},[e("span",{on:{click:t.onSaveTemplate}},[t._v(t._s(t.$t("m.systemConfig['确认']")))]),t._v(" "),e("span",{on:{click:t.cancelTemplate}},[t._v(t._s(t.$t("m.systemConfig['取消']")))])])],1)],1)],1)]),t._v(" "),e("create-ticket-dialog",{attrs:{"is-show":t.isCreateTicketDialogShow},on:{"update:isShow":function(e){t.isCreateTicketDialogShow=e},"update:is-show":function(e){t.isCreateTicketDialogShow=e}}}),t._v(" "),t.isRemindPageShow?e("create-ticket-success",{attrs:{"router-info":t.routerInfo},on:{onBackIconClick:t.onBackIconClick}}):t._e()],1)},n=[function(){var t=this._self._c;return t("div",{staticClass:"service-icon-wrap"},[t("span",{staticClass:"service-icon"},[t("i",{staticClass:"bk-itsm-icon icon-service"})])])}];a._withStripped=!0},dbV7:function(t,e,i){var a=i("Y7ZC");a(a.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},hrEm:function(t,e,i){"use strict";i.r(e);var a=i("ISVW"),n=i.n(a);for(var s in a)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(s);e.default=n.a},sj1o:function(t,e,i){"use strict";i("zr4d")},"y+Qj":function(t,e,i){"use strict";i.d(e,"a",(function(){return a})),i.d(e,"b",(function(){return n}));var a=function(){var t=this,e=t._self._c;return e("div",{staticClass:"tip-box"},[e("div",{staticClass:"tip-content"},[e("i",{staticClass:"bk-itsm-icon icon-success-fill"}),t._v(" "),e("span",[t._v(t._s(t.$t("m['提单成功']")))]),t._v(" "),e("p",[t._v(t._s(t.$t("m['当前流程已跳转至下一节点']"))+"，"+t._s(t.time)+"s"+t._s(t.$t("m['后将自动跳转至流程详情查看']")))]),t._v(" "),e("div",{staticClass:"tip-operation"},[e("bk-button",{staticClass:"back-list-btn",attrs:{theme:"default",type:"submit"},on:{click:t.onBackClick}},[t._v(t._s(t.$t("m['返回单据列表']")))]),t._v(" "),e("bk-button",{staticClass:"view-detail-btn",attrs:{theme:"primary"},on:{click:t.jumpPage}},[t._v(t._s(t.$t("m['查看流程详情']")))])],1)])])},n=[];a._withStripped=!0},"z/5e":function(t,e,i){t.exports={default:i("Nxk6"),__esModule:!0}},zr4d:function(t,e,i){}}]);