(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{"2vMD":function(e,t,o){"use strict";o.d(t,"a",(function(){return a})),o.d(t,"b",(function(){return s}));var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"bk-itsm-box"},[t("div",{staticClass:"is-title",class:{"bk-title-left":!e.sliderStatus}},[t("p",{staticClass:"bk-come-back"},[e._v("\n      "+e._s(e.$t('m.deployPage["流程设计"]'))+"\n    ")])]),e._v(" "),t("div",{staticClass:"itsm-page-content"},[e.versionStatus?t("div",{staticClass:"bk-itsm-version"},[t("i",{staticClass:"bk-icon icon-info-circle"}),e._v(" "),t("span",[e._v(e._s(e.$t('m.deployPage["流程设计：流程修改后，需要重新部署才能使改动生效"]')))]),e._v(" "),t("i",{staticClass:"bk-icon icon-close",on:{click:e.closeVersion}})]):e._e(),e._v(" "),t("div",{staticClass:"bk-design-table"},[t("div",{staticClass:"bk-only-btn"},[t("div",{staticClass:"bk-more-search"},[t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_create"])},expression:"{ active: !hasPermission(['workflow_create']) }"}],class:["mr10","plus-cus",{"btn-permission-disable":!e.hasPermission(["workflow_create"])}],attrs:{icon:"plus",theme:"primary",title:e.$t("m.deployPage['新增']")},on:{click:e.addProcess}},[e._v("\n            "+e._s(e.$t('m.deployPage["新增"]'))+"\n          ")]),e._v(" "),e.hasPermission(["workflow_create"])?t("bk-button",{staticClass:"mr10 bk-btn-file",attrs:{theme:"default",title:e.$t("m.deployPage['点击上传']")}},[t("input",{staticClass:"bk-input-file",attrs:{type:"file"},domProps:{value:e.fileVal},on:{change:e.handleFile}}),e._v("\n            "+e._s(e.$t('m.deployPage["导入"]'))+"\n          ")]):t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_create"])},expression:"{ active: !hasPermission(['workflow_create']) }"}],class:["mr10","bk-btn-file",{"btn-permission-disable":!e.hasPermission(["workflow_create"])}],attrs:{theme:"default",title:e.$t("m.deployPage['点击上传']")},on:{click:e.onProcessImportPermissonApply}},[e._v("\n            "+e._s(e.$t('m.deployPage["导入"]'))+"\n          ")]),e._v(" "),t("div",{staticClass:"bk-search-name"},[t("div",{staticClass:"bk-search-content"},[t("bk-input",{attrs:{clearable:!0,"right-icon":"bk-icon icon-search",placeholder:e.moreSearch[0].placeholder},on:{enter:e.searchContent,clear:e.clearSearch},model:{value:e.moreSearch[0].value,callback:function(t){e.$set(e.moreSearch[0],"value",t)},expression:"moreSearch[0].value"}})],1),e._v(" "),t("bk-button",{staticClass:"ml10 filter-btn",attrs:{title:e.$t("m.deployPage['更多筛选条件']"),icon:" bk-itsm-icon icon-search-more"},on:{click:e.searchMore}})],1)],1),e._v(" "),t("search-info",{ref:"searchInfo",attrs:{"more-search":e.moreSearch}})],1),e._v(" "),t("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.isDataLoading},expression:"{ isLoading: isDataLoading }"}],attrs:{data:e.dataList,size:"small",pagination:e.pagination},on:{"page-change":e.handlePageChange,"page-limit-change":e.handlePageLimitChange}},[t("bk-table-column",{attrs:{label:e.$t("m.common['ID']"),"min-width":"60"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.id}},[e._v(e._s(o.row.id||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.deployPage['流程名']"),"min-width":"200"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{staticClass:"bk-lable-primary",attrs:{title:o.row.name},on:{click:function(t){return e.onFlowEdit(o.row)}}},[e._v("\n              "+e._s(o.row.name)+"\n            ")])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.deployPage['说明']"),"min-width":"200"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.desc}},[e._v(e._s(o.row.desc||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.common['负责人']")},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.owners}},[e._v(e._s(o.row.owners||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.common['创建人']")},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.creator}},[e._v(e._s(o.row.creator||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.common['更新人']"),"min-width":"100"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.updated_by}},[e._v(e._s(o.row.updated_by||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.deployPage['更新时间']"),width:"180"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{attrs:{title:o.row.update_at}},[e._v(e._s(o.row.update_at||"--"))])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.deployPage['状态']"),width:"80"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("span",{staticClass:"bk-status-color",class:{"bk-status-gray":!o.row.is_enabled,"bk-status-primary":o.row.is_draft}}),e._v(" "),t("span",{staticStyle:{"margin-left":"5px"},attrs:{title:o.row.is_draft?e.$t("m.deployPage['草稿']"):o.row.is_enabled?e.$t("m.deployPage['启用']"):e.$t("m.deployPage['关闭']")}},[e._v("\n              "+e._s(o.row.is_draft?e.$t('m.deployPage["草稿"]'):o.row.is_enabled?e.$t('m.deployPage["启用"]'):e.$t('m.deployPage["关闭"]'))+"\n            ")])]}}])}),e._v(" "),t("bk-table-column",{attrs:{label:e.$t("m.deployPage['操作']"),width:"300"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_manage"],o.row.auth_actions)},expression:"{ active: !hasPermission(['workflow_manage'], props.row.auth_actions) }"}],class:[{"btn-permission-disable":!e.hasPermission(["workflow_manage"],o.row.auth_actions)}],attrs:{text:"",theme:"primary"},on:{click:function(t){return e.onFlowEdit(o.row)}}},[e._v("\n              "+e._s(e.$t('m.deployPage["编辑"]'))+"\n            ")]),e._v(" "),t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_deploy"],o.row.auth_actions)},expression:"{ active: !hasPermission(['workflow_deploy'], props.row.auth_actions) }"}],class:[{"btn-permission-disable":!e.hasPermission(["workflow_deploy"],o.row.auth_actions)}],attrs:{text:"",theme:"primary",disabled:e.hasPermission(["workflow_deploy"],o.row.auth_actions)&&(o.row.is_draft||!o.row.is_enabled)},on:{click:function(t){return e.onFlowDeploy(o.row)}}},[e._v("\n              "+e._s(e.$t('m.deployPage["部署"]'))+"\n            ")]),e._v(" "),t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_manage"],o.row.auth_actions)},expression:"{ active: !hasPermission(['workflow_manage'], props.row.auth_actions) }"}],class:[{"btn-permission-disable":!e.hasPermission(["workflow_manage"],o.row.auth_actions)}],attrs:{text:"",theme:"primary"},on:{click:function(t){return e.onFlowPreview(o.row)}}},[e._v("\n              "+e._s(e.$t('m.deployPage["预览"]'))+"\n            ")]),e._v(" "),t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_manage"],o.row.auth_actions)},expression:"{ active: !hasPermission(['workflow_manage'], props.row.auth_actions) }"}],class:[{"btn-permission-disable":!e.hasPermission(["workflow_manage"],o.row.auth_actions)}],attrs:{text:"",theme:"primary",disabled:e.hasPermission(["workflow_manage"],o.row.auth_actions)&&o.row.is_draft},on:{click:function(t){return e.onFlowExport(o.row)}}},[e._v("\n              "+e._s(e.$t('m.deployPage["导出"]'))+"\n            ")]),e._v(" "),t("bk-button",{directives:[{name:"cursor",rawName:"v-cursor",value:{active:!e.hasPermission(["workflow_manage"],o.row.auth_actions)},expression:"{ active: !hasPermission(['workflow_manage'], props.row.auth_actions) }"}],class:[{"btn-permission-disable":!e.hasPermission(["workflow_manage"],o.row.auth_actions)}],attrs:{text:"",theme:"primary"},on:{click:function(t){return e.deleteConfirm(o.row)}}},[e._v("\n              "+e._s(e.$t('m.deployPage["删除"]'))+"\n            ")])]}}])})],1),e._v(" "),t("bk-dialog",{attrs:{width:"760",position:e.processInfo.position,draggable:e.processInfo.draggable,title:e.processInfo.title},model:{value:e.processInfo.isShow,callback:function(t){e.$set(e.processInfo,"isShow",t)},expression:"processInfo.isShow"}},[t("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.processInfo.loading},expression:"{ isLoading: processInfo.loading }"}],staticStyle:{width:"100%",height:"347px"}},[e.processInfo.loading?e._e():t("preview",{attrs:{"add-list":e.addList,"line-list":e.lineList,"preview-info":e.previewInfo,"normal-color":e.normalColor}})],1),e._v(" "),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("bk-button",{attrs:{theme:"default"},on:{click:function(t){e.processInfo.isShow=!1}}},[e._v("\n            "+e._s(e.$t('m.deployPage["关闭"]'))+"\n          ")])],1)]),e._v(" "),t("bk-dialog",{attrs:{"render-directive":"if",width:e.deployInfo.width,"header-position":e.deployInfo.headerPosition,loading:e.secondClick,"auto-close":e.deployInfo.autoClose,"mask-close":e.deployInfo.autoClose},on:{confirm:e.submitForm},model:{value:e.deployInfo.isShow,callback:function(t){e.$set(e.deployInfo,"isShow",t)},expression:"deployInfo.isShow"}},[t("p",{attrs:{slot:"header"},slot:"header"},[e._v(e._s(e.$t('m.deployPage["确认部署"]')))]),e._v(" "),t("div",{staticClass:"bk-add-project"},[t("bk-form",{ref:"deployForm",attrs:{"label-width":200,"form-type":"vertical",model:e.deployInfo.formInfo,rules:e.rules}},[t("bk-form-item",{attrs:{label:e.$t("m.deployPage['部署流程名']"),required:!0,property:"name"}},[t("bk-input",{attrs:{maxlength:"120",placeholder:e.$t("m.deployPage['请输入部署流程名']")},model:{value:e.deployInfo.formInfo.name,callback:function(t){e.$set(e.deployInfo.formInfo,"name","string"==typeof t?t.trim():t)},expression:"deployInfo.formInfo.name"}})],1)],1)],1)])],1)])])},s=[];a._withStripped=!0},"2z9r":function(e,t,o){"use strict";o.r(t);var a=o("KXF5"),s=o.n(a);for(var i in a)["default"].indexOf(i)<0&&function(e){o.d(t,e,(function(){return a[e]}))}(i);t.default=s.a},CqoN:function(e,t,o){"use strict";o.r(t);var a=o("2vMD"),s=o("2z9r");for(var i in s)["default"].indexOf(i)<0&&function(e){o.d(t,e,(function(){return s[e]}))}(i);o("RvpB");var n=o("KHd+"),r=Object(n.a)(s.default,a.a,a.b,!1,null,"b630a306",null);t.default=r.exports},KXF5:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=c(o("vDqi")),s=c(o("PaSM")),i=c(o("Ah+g")),n=c(o("i8o3")),r=c(o("0hVY")),l=o("CeR/");function c(e){return e&&e.__esModule?e:{default:e}}t.default={name:"ProcessHome",components:{searchInfo:i.default,preview:n.default},mixins:[s.default,r.default],data:function(){return{versionStatus:!0,isDataLoading:!1,secondClick:!1,normalColor:!0,dataList:[],pagination:{current:1,count:10,limit:10},moreSearch:[{name:this.$t('m.deployPage["流程名"]'),desc:this.$t('m.deployPage["请输入流程名"]'),type:"input",typeKey:"name__icontains",value:"",multiSelect:!1,list:[]},{name:this.$t('m.deployPage["更新人"]'),desc:this.$t('m.deployPage["请输入更新人"]'),type:"member",typeKey:"updated_by__contains",multiSelect:!0,value:[],list:[]},{name:this.$t('m.deployPage["启用状态"]'),desc:this.$t('m.deployPage["请选择启用状态"]'),type:"select",typeKey:"is_enabled",multiSelect:!1,value:"",list:[{key:-1,name:this.$t('m.deployPage["草稿"]')},{key:0,name:this.$t('m.deployPage["关闭"]')},{key:1,name:this.$t('m.deployPage["启用"]')}]}],fileVal:"",processInfo:{isShow:!1,title:this.$t('m.flowManager["流程预览"]'),position:{top:150},draggable:!0,loading:!0},previewInfo:{canClick:!1,narrowSize:.8},addList:[],lineList:[],deployInfo:{isShow:!1,width:700,headerPosition:"left",autoClose:!1,precision:0,formInfo:{name:"",id:""}},rules:{}}},computed:{sliderStatus:function(){return this.$store.state.common.slideStatus}},mounted:function(){this.getList(),this.rules.name=this.checkCommonRules("name").name},methods:{getList:function(e){var t=this;void 0!==e&&(this.pagination.current=e);var o={page:this.pagination.current,page_size:this.pagination.limit};this.moreSearch.forEach((function(e){(Array.isArray(e.value)?e.value.length:""!==e.value)&&"is_enabled"!==e.typeKey&&(o[e.typeKey]=Array.isArray(e.value)?e.value.join(","):e.value)})),-1===this.moreSearch[2].value?(o.is_draft=1,o.is_enabled=""):0===this.moreSearch[2].value?(o.is_enabled=0,o.is_draft=0):1===this.moreSearch[2].value&&(o.is_enabled=1),this.isDataLoading=!0,this.$store.dispatch("deployCommon/getList",o).then((function(e){t.dataList=e.data.items,t.pagination.current=e.data.page,t.pagination.count=e.data.count})).catch((function(e){(0,l.errorHandler)(e,t)})).finally((function(){t.isDataLoading=!1}))},handlePageLimitChange:function(){this.pagination.limit=arguments[0],this.getList()},handlePageChange:function(e){this.pagination.current=e,this.getList()},searchContent:function(){this.getList(1)},searchMore:function(){this.$refs.searchInfo.searchMore()},clearSearch:function(){this.moreSearch.forEach((function(e){e.value=e.multiSelect?[]:""})),this.getList(1)},addProcess:function(){if(this.hasPermission(["workflow_create"]))this.$router.push({name:"ProcessEdit",params:{type:"new",step:"processInfo"}});else{var e=this.$store.state.project.projectInfo,t={project:[{id:e.key,name:e.name}]};this.applyForPermission(["workflow_create"],[],t)}},onFlowEdit:function(e){this.CheckFowPermisson(e)&&this.$router.push({name:"ProcessEdit",params:{type:"edit",step:"processInfo"},query:{processId:e.id}})},handleFile:function(e){var t=this,o=e.target.files[0];if(o.size<=10485760){var a=new FormData;a.append("file",o);this.$store.dispatch("cdeploy/flowFileUpload",{fileType:"json",data:a}).then((function(e){t.$bkMessage({message:t.$t('m.deployPage["成功导入"]')+"\n                                "+e.data.success+"\n                                "+t.$t('m.deployPage["个流程，"]')+"\n                                "+t.$t('m.deployPage["失败"]')+"\n                                "+e.data.failed+"\n                                "+t.$t('m.deployPage["个"]'),theme:"success"}),t.getList(1)})).catch((function(e){(0,l.errorHandler)(e,t)})).finally((function(){t.fileVal="",e.target.value=null}))}else this.fileVal="",e.target.value=null,this.$bkMessage({message:this.$t('m.deployPage["文件大小不能超过10MB"]'),theme:"error"})},onFlowDeploy:function(e){this.CheckFowPermisson(e,["workflow_deploy"])&&!e.is_draft&&e.is_enabled&&(this.deployInfo.isShow=!0,this.deployInfo.formInfo.name=e.name,this.deployInfo.formInfo.id=e.id)},submitForm:function(){var e=this;this.$refs.deployForm.validate().then((function(){if(!e.secondClick){e.secondClick=!0;var t=e.deployInfo.formInfo.id,o={name:e.deployInfo.formInfo.name};e.$store.dispatch("cdeploy/deployFlow",{params:o,id:t}).then((function(){e.$bkMessage({message:e.$t('m.deployPage["流程部署成功，请关联服务后使用"]'),theme:"success"})})).catch((function(t){(0,l.errorHandler)(t,e)})).finally((function(){e.secondClick=!1,e.deployInfo.isShow=!1}))}}),(function(){}))},onFlowPreview:function(e){var t=this;if(this.CheckFowPermisson(e)){var o=e.id;o&&(this.processInfo.isShow=!this.processInfo.isShow,this.processInfo.loading=!0,a.default.all([this.$store.dispatch("deployCommon/getStates",{workflow:o}),this.$store.dispatch("deployCommon/getChartLink",{workflow:o,page_size:1e3})]).then(a.default.spread((function(e,o){t.addList=e.data;for(var a=0;a<t.addList.length;a++)t.addList[a].indexInfo=a;t.lineList=o.data.items}))).finally((function(){t.processInfo.loading=!1})))}},onFlowExport:function(e){this.CheckFowPermisson(e)&&this.$bkInfo({title:this.$t('m.deployPage["确认导出？"]'),confirmFn:function(){window.open(window.SITE_URL+"api/workflow/templates/"+e.id+"/exports/")}})},deleteConfirm:function(e){var t=this;this.CheckFowPermisson(e)&&this.$bkInfo({type:"warning",title:this.$t('m.deployPage["确认删除此流程？"]'),subTitle:this.$t('m.deployPage["流程一旦删除，将无法还原，请谨慎操作"]'),confirmFn:function(){var o=e.id;t.secondClick||(t.secondClick=!0,t.$store.dispatch("cdeploy/deleteDesign",{params:o}).then((function(){t.$bkMessage({message:t.$t('m.systemConfig["删除成功"]'),theme:"success"}),1===t.dataList.length&&(t.pagination.current=1===t.pagination.current?1:t.pagination.current-1),t.getList()})).catch((function(e){(0,l.errorHandler)(e,t)})).finally((function(){t.secondClick=!1})))}})},closeVersion:function(){this.versionStatus=!1},onProcessImportPermissonApply:function(){if(!this.hasPermission(["workflow_create"])){var e=this.$store.state.project.projectInfo,t={project:[{id:e.key,name:e.name}]};this.applyForPermission(["workflow_create"],[],t)}},CheckFowPermisson:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["workflow_manage"];if(!this.hasPermission(t,e.auth_actions)){var o=this.$store.state.project.projectInfo,a={project:[{id:o.key,name:o.name}],workflow:[{id:e.id,name:e.name}]};return this.applyForPermission(t,e.auth_actions,a),!1}return!0}}}},RvpB:function(e,t,o){"use strict";o("i87e")},i87e:function(e,t,o){}}]);